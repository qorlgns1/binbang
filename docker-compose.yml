services:
  # ==============================
  # Next.js Web
  # ==============================
  web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        DATABASE_URL: ${DATABASE_URL}
    ports:
      - "4000:3000"
    environment:
      DATABASE_URL: ${DATABASE_URL}
      NEXTAUTH_URL: ${NEXTAUTH_URL}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      KAKAO_CLIENT_ID: ${KAKAO_CLIENT_ID}
      KAKAO_CLIENT_SECRET: ${KAKAO_CLIENT_SECRET}
      TZ: Asia/Seoul
    restart: unless-stopped
    depends_on:
      - worker

  # ==============================
  # Worker (Cron / Monitoring)
  # ==============================
  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    environment:
      DATABASE_URL: ${DATABASE_URL}
      KAKAO_CLIENT_ID: ${KAKAO_CLIENT_ID}
      KAKAO_CLIENT_SECRET: ${KAKAO_CLIENT_SECRET}
      CRON_SCHEDULE: ${CRON_SCHEDULE:-*/10 * * * *}
      WORKER_CONCURRENCY: ${WORKER_CONCURRENCY:-10}
      BROWSER_POOL_SIZE: ${BROWSER_POOL_SIZE:-3}
      TZ: Asia/Seoul
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
