version: "3.8"

# =====================================================
# docker-compose.local.yml
#
# âœ” ë¡œì»¬ ê°œë°œ ì „ìš©
# âœ” Docker ê¸°ë°˜ í†µí•© í…ŒìŠ¤íŠ¸ìš©
# âœ” ìš´ì˜ í™˜ê²½ ì‚¬ìš© ê¸ˆì§€
#
# íŠ¹ì§•
# - DB: ì—†ìœ¼ë©´ ìë™ ìƒì„± / ìˆìœ¼ë©´ ì¬ì‚¬ìš©
# - Web: Next.js dev + Hot Reload
# - Worker: ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš© ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…
# =====================================================

services:
  # ---------------------------------------------------
  # PostgreSQL (Local Development)
  # ---------------------------------------------------
  db:
    image: postgres:15
    container_name: accommodation-monitor-db-local

    environment:
      # ìµœì´ˆ ì‹¤í–‰ ì‹œì—ë§Œ ì‚¬ìš©ë¨ (ì´ë¯¸ DB ìˆìœ¼ë©´ ë¬´ì‹œë¨)
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_DB: ${DB_NAME:-accommodation_monitor_local}

    # ë¡œì»¬ DB íˆ´(DBeaver ë“±) ì ‘ê·¼ìš©
    ports:
      - "${DB_PORT:-5432}:5432"

    # named volume ì‚¬ìš© â†’ DB ìë™ ìƒì„± / ì¬ì‚¬ìš©ì˜ í•µì‹¬
    volumes:
      - postgres_data:/var/lib/postgresql/data

    # DB ì¤€ë¹„ ìƒíƒœ ì²´í¬
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-postgres}"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ---------------------------------------------------
  # Next.js Web (Local Dev + Hot Reload)
  # ---------------------------------------------------
  web:
    build:
      context: .
      dockerfile: Dockerfile

    container_name: accommodation-monitor-web-local

    ports:
      - "${WEB_PORT:-3000}:3000"

    environment:
      # Prisma / API ì„œë²„ DB ì—°ê²°
      DATABASE_URL: postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-postgres}@db:5432/${DB_NAME:-accommodation_monitor_local}

      # NextAuth (ë¡œì»¬ ê¸°ì¤€)
      NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost:3000}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}

      # OAuth
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      KAKAO_CLIENT_ID: ${KAKAO_CLIENT_ID}
      KAKAO_CLIENT_SECRET: ${KAKAO_CLIENT_SECRET}

      # ëª…ì‹œì  ê°œë°œ ëª¨ë“œ
      NODE_ENV: development

    # DB ì¤€ë¹„ í›„ ì‹¤í–‰
    depends_on:
      db:
        condition: service_healthy

    # ğŸ”¥ Hot Reload í•µì‹¬
    volumes:
      # ë¡œì»¬ ì†ŒìŠ¤ â†’ ì»¨í…Œì´ë„ˆ
      - ./:/app

      # node_modulesëŠ” ì»¨í…Œì´ë„ˆ ì „ìš© (OS ì°¨ì´ ë°©ì§€)
      - /app/node_modules

      # Next.js ë¹Œë“œ ìºì‹œ ê²©ë¦¬
      - /app/.next

    # âš ï¸ Prisma db push ìë™ ì‹¤í–‰ ê¸ˆì§€
    # í•„ìš”í•  ë•Œë§Œ ìˆ˜ë™ ì‹¤í–‰:
    # docker compose exec web npx prisma db push
    command: sh -c "npx prisma generate && npm run dev"

  # ---------------------------------------------------
  # Background Worker (Local Test Only)
  # ---------------------------------------------------
  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker

    container_name: accommodation-monitor-worker-local

    environment:
      DATABASE_URL: postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-postgres}@db:5432/${DB_NAME:-accommodation_monitor_local}

      KAKAO_CLIENT_ID: ${KAKAO_CLIENT_ID}
      KAKAO_CLIENT_SECRET: ${KAKAO_CLIENT_SECRET}

      # ê¸°ë³¸ê°’: 10ë¶„ ì£¼ê¸°
      CRON_SCHEDULE: ${CRON_SCHEDULE:-*/10 * * * *}

      # ë³‘ë ¬ ì²˜ë¦¬ ì„¤ì •
      WORKER_CONCURRENCY: ${WORKER_CONCURRENCY:-10}
      BROWSER_POOL_SIZE: ${BROWSER_POOL_SIZE:-3}

    depends_on:
      db:
        condition: service_healthy

    # ë¡œì»¬ì—ì„œ ì›Œì»¤ ì½”ë“œë„ ì¦‰ì‹œ ë°˜ì˜
    volumes:
      - ./:/app
      - /app/node_modules

    # docker-composeì—ì„œ ì‹¤ì œë¡œ ì ìš©ë˜ëŠ” ë©”ëª¨ë¦¬ ì œí•œ
    # mem_limit: 1g

# ---------------------------------------------------
# Volumes
# ---------------------------------------------------
volumes:
  postgres_data:
