name: Deploy

on:
  push:
    branches: ['main', 'develop']

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

permissions: {}

jobs:
  validate:
    uses: ./.github/workflows/ci.yml
    permissions:
      contents: read

  docker:
    name: Build and Push
    needs: validate
    runs-on: ubuntu-24.04-arm
    environment: ${{ github.ref_name }}
    permissions:
      contents: read
    outputs:
      image_tag: ${{ steps.vars.outputs.image_tag }}
      web_digest: ${{ steps.digests.outputs.web_digest }}
      worker_digest: ${{ steps.digests.outputs.worker_digest }}
      travel_digest: ${{ steps.digests.outputs.travel_digest }}
    steps:
      - uses: actions/checkout@v6

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Resolve tags
        id: vars
        run: |
          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            echo "image_tag=main" >> "$GITHUB_OUTPUT"
          else
            echo "image_tag=develop" >> "$GITHUB_OUTPUT"
          fi

      - name: Build and push
        id: bake
        uses: docker/bake-action@v6
        with:
          files: docker/docker-bake.hcl
          push: true
        env:
          TAG: ${{ steps.vars.outputs.image_tag }}
          NEXT_PUBLIC_GA_MEASUREMENT_ID: ${{ vars.NEXT_PUBLIC_GA_MEASUREMENT_ID }}
          NEXT_PUBLIC_NAVER_SITE_VERIFICATION: ${{ vars.NEXT_PUBLIC_NAVER_SITE_VERIFICATION }}
          NEXT_PUBLIC_GOOGLE_SITE_VERIFICATION: ${{ vars.NEXT_PUBLIC_GOOGLE_SITE_VERIFICATION }}
          NEXT_PUBLIC_GOOGLE_MAPS_API_KEY: ${{ vars.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}

      - name: Extract digests
        id: digests
        env:
          METADATA: ${{ steps.bake.outputs.metadata }}
        run: |
          web_digest=$(jq -r '.web["containerimage.digest"]' <<<"$METADATA")
          worker_digest=$(jq -r '.worker["containerimage.digest"]' <<<"$METADATA")
          travel_digest=$(jq -r '.travel["containerimage.digest"]' <<<"$METADATA")
          echo "web_digest=$web_digest" >> "$GITHUB_OUTPUT"
          echo "worker_digest=$worker_digest" >> "$GITHUB_OUTPUT"
          echo "travel_digest=$travel_digest" >> "$GITHUB_OUTPUT"

  deploy:
    name: Deploy to OCI
    needs: docker
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name }}
    permissions:
      contents: read
    steps:
      - name: Deploy
        uses: appleboy/ssh-action@v1.2.5
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ${{ secrets.OCI_USER }}
          key: ${{ secrets.OCI_SSH_KEY }}
          port: ${{ secrets.OCI_PORT }}
          script: |
            set -e
            cd ~/workspace/binbang

            # --- 서버 셸 환경 (non-interactive에서도 node/pnpm 사용 가능하도록) ---
            [ -f ~/.profile ] && . ~/.profile
            [ -f ~/.bashrc ] && . ~/.bashrc
            export NVM_DIR="${NVM_DIR:-$HOME/.nvm}"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            export CI=true
            if command -v corepack >/dev/null 2>&1; then
              corepack enable
              corepack prepare pnpm@10.28.0 --activate
            fi
            if ! command -v pnpm >/dev/null 2>&1 && [ -x ./node_modules/.bin/pnpm ]; then
              export PATH="$PWD/node_modules/.bin:$PATH"
            fi
            if ! command -v pnpm >/dev/null 2>&1; then
              echo "ERROR: pnpm not found on server. Check PATH and Node/pnpm setup." >&2
              echo "PATH=$PATH" && echo "NVM_DIR=$NVM_DIR"
              command -v node >/dev/null 2>&1 && echo "node=$(command -v node)" || echo "node=not found"
              exit 1
            fi

            # --- 브랜치/환경 변수 설정 ---
            BRANCH="${{ github.ref_name }}"
            if [ "$BRANCH" = "main" ]; then
              export APP_ENV=production
              COMPOSE_FILE="docker/docker-compose.production.yml"
              COMPOSE_OPTS=""
              # production만 compose 해석 시 ${IMAGE_TAG}, ${IMAGE_*_DIGEST} 필요
              COMPOSE_ENV_OPTS="--env-file .env.deploy.production"
            else
              export APP_ENV=development
              COMPOSE_FILE="docker/docker-compose.develop.yml"
              COMPOSE_OPTS="-p binbang-dev"
              # develop은 이미지 이름 하드코딩이라 --env-file 불필요
              COMPOSE_ENV_OPTS=""
            fi
            DEPLOY_FILE=".env.deploy.${APP_ENV}"

            # --- 리포 최신화 ---
            git fetch origin "$BRANCH"
            git checkout -B "$BRANCH" "origin/$BRANCH"
            git reset --hard "origin/$BRANCH"

            update_env_var() {
              key="$1"
              value="$2"
              file="$3"
              escaped_value=$(printf '%s' "$value" | sed -e 's/[\\&|]/\\&/g')
              if grep -q "^${key}=" "$file" 2>/dev/null; then
                sed -i "s|^${key}=.*|${key}=${escaped_value}|" "$file"
              else
                echo "${key}=${value}" >> "$file"
              fi
            }

            # --- 배포 메타데이터 기록 (.env.deploy.<env>) ---
            update_env_var IMAGE_TAG          "${{ needs.docker.outputs.image_tag }}"    "$DEPLOY_FILE"
            update_env_var IMAGE_WEB_DIGEST   "${{ needs.docker.outputs.web_digest }}"   "$DEPLOY_FILE"
            update_env_var IMAGE_WORKER_DIGEST "${{ needs.docker.outputs.worker_digest }}" "$DEPLOY_FILE"
            update_env_var IMAGE_TRAVEL_DIGEST "${{ needs.docker.outputs.travel_digest }}" "$DEPLOY_FILE"
            update_env_var DEPLOY_SHA         "${{ github.sha }}"                        "$DEPLOY_FILE"
            update_env_var DEPLOYED_AT        "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"         "$DEPLOY_FILE"

            # --- 이미지 pull ---
            docker compose $COMPOSE_OPTS -f "$COMPOSE_FILE" $COMPOSE_ENV_OPTS \
              pull

            # --- DB 마이그레이션 ---
            pnpm db:migrate:deploy
            pnpm db:generate
            pnpm db:seed:base

            # --- develop 전용: 테스트 데이터 seed ---
            if [ "$APP_ENV" = "development" ]; then
              pnpm db:seed
            fi

            # --- 서비스 재시작 ---
            docker compose $COMPOSE_OPTS -f "$COMPOSE_FILE" $COMPOSE_ENV_OPTS \
              up -d
