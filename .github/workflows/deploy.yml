name: Deploy

on:
  push:
    branches: ['main', 'develop']

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

permissions: {}

jobs:
  validate:
    uses: ./.github/workflows/ci.yml
    permissions:
      contents: read

  docker:
    name: Build and Push
    needs: validate
    runs-on: ubuntu-24.04-arm
    environment: ${{ github.ref_name }}
    permissions:
      contents: read
    outputs:
      image_tag: ${{ steps.vars.outputs.image_tag }}
      web_digest: ${{ steps.digests.outputs.web_digest }}
      worker_digest: ${{ steps.digests.outputs.worker_digest }}
    steps:
      - uses: actions/checkout@v6

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Resolve tags
        id: vars
        run: |
          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            echo "image_tag=main" >> "$GITHUB_OUTPUT"
          else
            echo "image_tag=develop" >> "$GITHUB_OUTPUT"
          fi

      - name: Build and push
        id: bake
        uses: docker/bake-action@v6
        with:
          files: docker-bake.hcl
          push: true
        env:
          TAG: ${{ steps.vars.outputs.image_tag }}
          NEXT_PUBLIC_GA_MEASUREMENT_ID: ${{ vars.NEXT_PUBLIC_GA_MEASUREMENT_ID }}
          NEXT_PUBLIC_NAVER_SITE_VERIFICATION: ${{ vars.NEXT_PUBLIC_NAVER_SITE_VERIFICATION }}
          NEXT_PUBLIC_GOOGLE_SITE_VERIFICATION: ${{ vars.NEXT_PUBLIC_GOOGLE_SITE_VERIFICATION }}

      - name: Extract digests
        id: digests
        run: |
          METADATA='${{ steps.bake.outputs.metadata }}'
          echo "web_digest=$(echo "$METADATA" | jq -r '.web."containerimage.digest"')" >> "$GITHUB_OUTPUT"
          echo "worker_digest=$(echo "$METADATA" | jq -r '.worker."containerimage.digest"')" >> "$GITHUB_OUTPUT"

  deploy:
    name: Deploy to OCI
    needs: docker
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Deploy
        uses: appleboy/ssh-action@v1.2.5
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ${{ secrets.OCI_USER }}
          key: ${{ secrets.OCI_SSH_KEY }}
          port: ${{ secrets.OCI_PORT }}
          script: |
            set -e
            cd ~/workspace/accommodation-monitor
            BRANCH="${{ github.ref_name }}"
            git fetch origin "$BRANCH"
            git checkout -B "$BRANCH" "origin/$BRANCH"
            git reset --hard "origin/$BRANCH"

            update_env_var() {
              key="$1"
              value="$2"
              if grep -q "^${key}=" .env.production; then
                sed -i "s|^${key}=.*|${key}=${value}|" .env.production
              else
                echo "${key}=${value}" >> .env.production
              fi
            }

            if [ "${{ github.ref_name }}" = "main" ]; then
              IMAGE_TAG=${{ needs.docker.outputs.image_tag }}
              WEB_DIGEST=${{ needs.docker.outputs.web_digest }}
              WORKER_DIGEST=${{ needs.docker.outputs.worker_digest }}
              DEPLOY_SHA=${{ github.sha }}
              DEPLOYED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

              update_env_var IMAGE_TAG "$IMAGE_TAG"
              update_env_var IMAGE_WEB_DIGEST "$WEB_DIGEST"
              update_env_var IMAGE_WORKER_DIGEST "$WORKER_DIGEST"
              update_env_var DEPLOY_SHA "$DEPLOY_SHA"
              update_env_var DEPLOYED_AT "$DEPLOYED_AT"

              docker compose -f docker-compose.production.yml --env-file .env.production pull
              docker compose -f docker-compose.production.yml --env-file .env.production up -d
            else
              docker compose -p accommodation-monitor-dev -f docker-compose.develop.yml --env-file .env.develop pull
              docker compose -p accommodation-monitor-dev -f docker-compose.develop.yml --env-file .env.develop up -d
            fi
