name: Deploy

on:
  push:
    branches: ['main', 'develop']

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

permissions: {}

jobs:
  validate:
    uses: ./.github/workflows/ci.yml
    permissions:
      contents: read

  docker:
    name: Build and Push
    needs: validate
    runs-on: ubuntu-24.04-arm
    environment: ${{ github.ref_name }}
    permissions:
      contents: read
    outputs:
      image_tag: ${{ steps.vars.outputs.image_tag }}
      web_digest: ${{ steps.digests.outputs.web_digest }}
      worker_digest: ${{ steps.digests.outputs.worker_digest }}
    steps:
      - uses: actions/checkout@v6

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Resolve tags
        id: vars
        run: |
          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            echo "image_tag=main" >> "$GITHUB_OUTPUT"
          else
            echo "image_tag=develop" >> "$GITHUB_OUTPUT"
          fi

      - name: Build and push
        id: bake
        uses: docker/bake-action@v6
        with:
          files: docker/docker-bake.hcl
          push: true
        env:
          TAG: ${{ steps.vars.outputs.image_tag }}
          NEXT_PUBLIC_GA_MEASUREMENT_ID: ${{ vars.NEXT_PUBLIC_GA_MEASUREMENT_ID }}
          NEXT_PUBLIC_NAVER_SITE_VERIFICATION: ${{ vars.NEXT_PUBLIC_NAVER_SITE_VERIFICATION }}
          NEXT_PUBLIC_GOOGLE_SITE_VERIFICATION: ${{ vars.NEXT_PUBLIC_GOOGLE_SITE_VERIFICATION }}

      - name: Extract digests
        id: digests
        env:
          METADATA: ${{ steps.bake.outputs.metadata }}
        run: |
          web_digest=$(jq -r '.web["containerimage.digest"]' <<<"$METADATA")
          worker_digest=$(jq -r '.worker["containerimage.digest"]' <<<"$METADATA")
          echo "web_digest=$web_digest" >> "$GITHUB_OUTPUT"
          echo "worker_digest=$worker_digest" >> "$GITHUB_OUTPUT"

  deploy:
    name: Deploy to OCI
    needs: docker
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name }}
    permissions:
      contents: read
    steps:
      - name: Deploy
        uses: appleboy/ssh-action@v1.2.5
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ${{ secrets.OCI_USER }}
          key: ${{ secrets.OCI_SSH_KEY }}
          port: ${{ secrets.OCI_PORT }}
          script: |
            set -e
            cd ~/workspace/binbang

            # --- 서버 셸 환경 (non-interactive에서도 node/pnpm 사용 가능하도록) ---
            [ -f ~/.profile ] && . ~/.profile
            [ -f ~/.bashrc ] && . ~/.bashrc
            export NVM_DIR="${NVM_DIR:-$HOME/.nvm}"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            export CI=true
            if command -v corepack >/dev/null 2>&1; then
              corepack enable
              corepack prepare pnpm@10.28.0 --activate
            fi
            if ! command -v pnpm >/dev/null 2>&1 && [ -x ./node_modules/.bin/pnpm ]; then
              export PATH="$PWD/node_modules/.bin:$PATH"
            fi
            if ! command -v pnpm >/dev/null 2>&1; then
              echo "ERROR: pnpm not found on server. Check PATH and Node/pnpm setup." >&2
              echo "PATH=$PATH" && echo "NVM_DIR=$NVM_DIR"
              command -v node >/dev/null 2>&1 && echo "node=$(command -v node)" || echo "node=not found"
              exit 1
            fi

            # --- 리포 최신화 ---
            BRANCH="${{ github.ref_name }}"
            git fetch origin "$BRANCH"
            git checkout -B "$BRANCH" "origin/$BRANCH"
            git reset --hard "origin/$BRANCH"

            update_env_var() {
              key="$1"
              value="$2"
              file="$3"
              # sed replacement safety: escape delimiter(|), backslash, and &
              escaped_value=$(printf '%s' "$value" | sed -e 's/[\\&|]/\\&/g')
              if grep -q "^${key}=" "$file" 2>/dev/null; then
                sed -i "s|^${key}=.*|${key}=${escaped_value}|" "$file"
              else
                echo "${key}=${value}" >> "$file"
              fi
            }

            # --- main: 프로덕션 배포 (셸은 .env.production.local, 컨테이너는 .env.production, seed 없음) ---
            if [ "${{ github.ref_name }}" = "main" ]; then
              IMAGE_TAG=${{ needs.docker.outputs.image_tag }}
              WEB_DIGEST=${{ needs.docker.outputs.web_digest }}
              WORKER_DIGEST=${{ needs.docker.outputs.worker_digest }}
              update_env_var IMAGE_TAG "$IMAGE_TAG" .env.production
              update_env_var IMAGE_WEB_DIGEST "$WEB_DIGEST" .env.production
              update_env_var IMAGE_WORKER_DIGEST "$WORKER_DIGEST" .env.production
              update_env_var DEPLOY_SHA "${{ github.sha }}" .env.production
              update_env_var DEPLOYED_AT "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" .env.production

              docker compose -f docker/docker-compose.production.yml --env-file .env.production pull
              pnpm with-env:production:host pnpm --filter @workspace/db exec prisma migrate deploy
              pnpm with-env:production:host pnpm --filter @workspace/db exec prisma generate
              pnpm with-env:production:host pnpm --filter @workspace/db exec tsx prisma/seed-base.ts

              
              docker compose -f docker/docker-compose.production.yml --env-file .env.production up -d
              exit 0
            fi

            # --- develop: 셸에서는 .env.development.local(DATABASE_URL) 사용, 컨테이너는 .env.development만 사용 ---
            docker compose -p binbang-dev -f docker/docker-compose.develop.yml --env-file .env.development pull
            pnpm with-env:development:host pnpm --filter @workspace/db exec prisma migrate deploy
            pnpm with-env:development:host pnpm --filter @workspace/db exec prisma generate
            pnpm with-env:development:host pnpm --filter @workspace/db exec tsx prisma/seed-base.ts
            pnpm with-env:development:host pnpm --filter @workspace/db db:seed
            docker compose -p binbang-dev -f docker/docker-compose.develop.yml --env-file .env.development up -d
