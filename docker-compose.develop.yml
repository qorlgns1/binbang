services:
  browser:
    image: ghcr.io/browserless/chromium
    environment:
      TOKEN: ${BROWSERLESS_TOKEN:-local-token}
      CONCURRENT: ${BROWSERLESS_CONCURRENT:-5}
      TIMEOUT: ${BROWSERLESS_TIMEOUT:-300000}
    expose:
      - '3000'
    shm_size: 1gb
    restart: unless-stopped

  web:
    image: kihoonbae/accommodation-monitor:web-develop
    ports:
      - '4000:3000'
    environment:
      NODE_ENV: development
      DATABASE_URL: ${DATABASE_URL}
      NEXTAUTH_URL: ${NEXTAUTH_URL}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      KAKAO_CLIENT_ID: ${KAKAO_CLIENT_ID}
      KAKAO_CLIENT_SECRET: ${KAKAO_CLIENT_SECRET}
    restart: unless-stopped

  worker:
    image: kihoonbae/accommodation-monitor:worker-develop
    environment:
      NODE_ENV: development
      DATABASE_URL: ${DATABASE_URL}
      KAKAO_CLIENT_ID: ${KAKAO_CLIENT_ID}
      KAKAO_CLIENT_SECRET: ${KAKAO_CLIENT_SECRET}
      CRON_SCHEDULE: ${CRON_SCHEDULE:-*/30 * * * *}
      WORKER_CONCURRENCY: ${WORKER_CONCURRENCY:-1}
      BROWSER_POOL_SIZE: ${BROWSER_POOL_SIZE:-1}
      BLOCK_RESOURCE_TYPES: ${BLOCK_RESOURCE_TYPES:-image,media,font}
      PUPPETEER_WS_ENDPOINT: ${PUPPETEER_WS_ENDPOINT:-ws://browser:3000?token=${BROWSERLESS_TOKEN:-local-token}}
      NAVIGATION_TIMEOUT_MS: ${NAVIGATION_TIMEOUT_MS:-25000}
      CONTENT_WAIT_MS: ${CONTENT_WAIT_MS:-10000}
      PATTERN_RETRY_MS: ${PATTERN_RETRY_MS:-5000}
    restart: unless-stopped
    depends_on:
      - browser
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
